CREATE DATABASE QL_HOMESTAY1
GO

USE QL_HOMESTAY1
GO


CREATE TABLE PHONG
( 
  MAPHONG CHAR(8),
  TENPHONG NVARCHAR(100),
  LOAIPHONG NVARCHAR(100),
  GIAPHONG INT,
  TIENNGHI NVARCHAR(100),
  TRANGTHAI NVARCHAR(100),   -- Ví dụ trạng thái là: đang trống, đã được đặt , đang sửa chữa 
  CONSTRAINT PHONG_PK PRIMARY KEY (MAPHONG)
)


CREATE TABLE KHACHHANG
(
  MAKH CHAR(8),
  TENKH NVARCHAR(100),
  GIOITINH NVARCHAR(30),
  NGAYSINH DATE,
  DIACHI NVARCHAR(100),
  SDT char(20),
  CONSTRAINT KHACHHANG_PK PRIMARY KEY (MAKH),
)


CREATE TABLE NHANVIEN
( 
  MANV CHAR(8),
  TENNV NVARCHAR(100),
  GIOITINH NVARCHAR(30),
  NGAYSINH DATE,
  DIACHI NVARCHAR(100),
  SDT char(20),
  TAIKHOAN NVARCHAR(100),
  MATKHAU NVARCHAR(100),
  QUYEN NVARCHAR(100),
  AVATAR CHAR(100),
  CONSTRAINT NHANVIEN_PK PRIMARY KEY (MANV)
)


CREATE TABLE DATPHONG
(
  MADP CHAR(8),
  MAPHONG CHAR(8),
  MAKH CHAR(8),
  NGAYDATPHONG DATE,
  NGAYTRAPHONG DATE,
  SONGUOI INT,
  CONSTRAINT DATPHONG_PK PRIMARY KEY (MADP),
  CONSTRAINT DATPHONG_FK FOREIGN KEY (MAPHONG) REFERENCES PHONG(MAPHONG),
  CONSTRAINT DATPHONG_FK1 FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)
) 


CREATE TABLE LOAIDV
(
  MALDV CHAR(8),
  TENLOAIDV NVARCHAR(100),
  CONSTRAINT LOAIDV_PK PRIMARY KEY (MALDV)
)


CREATE TABLE DICHVU
( 
  MADV CHAR(8),
  TENDV NVARCHAR(100),
  MALDV CHAR(8),
  GIADV MONEY,
  CONSTRAINT DICHVU_PK PRIMARY KEY (MADV),
  CONSTRAINT DICHVU_FK FOREIGN KEY (MALDV) REFERENCES LOAIDV(MALDV)
)


CREATE TABLE PHUCVU
(
  MAPV CHAR(8),
  MADV CHAR(8),
  MAPHONG CHAR(8),
  SL INT,
  CONSTRAINT PHUCVU_PK PRIMARY KEY (MAPV),
  CONSTRAINT PHUCVU_FK FOREIGN KEY (MADV) REFERENCES DICHVU(MADV),
  CONSTRAINT PHUCVU_FK1 FOREIGN KEY (MAPHONG) REFERENCES PHONG(MAPHONG)
)

CREATE TABLE HOADON
( 
  MAHD int NOT NULL IDENTITY(1,1),
  MADP CHAR(8),
  MAKH CHAR(8),
  MAPHONG CHAR(8),
  NGAYLAPHD DATE,
  TONGTIENHD money,
  MANV CHAR(8),   --- NHÂN VIÊN LẬP HÓA ĐƠN
  CONSTRAINT HOADON_PK PRIMARY KEY (MAHD),
  CONSTRAINT HOADON_FK2 FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV),
  CONSTRAINT HOADON_FK3 FOREIGN KEY (MADP) REFERENCES DATPHONG(MADP),
  CONSTRAINT HOADON_FK4 FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH),
  CONSTRAINT HOADON_FK5 FOREIGN KEY (MAPHONG) REFERENCES PHONG(MAPHONG),
)


GO


INSERT INTO PHONG(MAPHONG, TENPHONG, LOAIPHONG, GIAPHONG, TIENNGHI, TRANGTHAI)
VALUES 
('P001', N'HOME STAY 01', N'PHÒNG CỔ ĐIỂN', '1200000', N'GƯỜNG LỚN, MÁY CHIẾU, BAN CÔNG NHỎ', N'ĐÃ ĐƯỢC ĐẶT'),
('P002', N'HOME STAY 02', N'PHÒNG CỔ ĐIỂN', '1300000', N'GƯỜNG LỚN, MÁY CHIẾU, BAN CÔNG LỚN', N'ĐÃ ĐƯỢC ĐẶT'),
('P003', N'HOME STAY 03', N'PHÒNG CHILL', '1250000', N'GƯỜNG LỚN, MÁY CHIẾU, BẾP NẤU', N'ĐÃ ĐƯỢC ĐẶT'),
('P004', N'HOME STAY 04', N'PHÒNG VIP', '1600000', N'ĐẦY ĐỦ TIỆN NGHI', N'ĐÃ ĐƯỢC ĐẶT'),
('P005', N'HOME STAY 05', N'PHÒNG CHILL', '1250000', N'GƯỜNG LỚN, MÁY CHIẾU, BẾP NẤU', N'ĐÃ ĐƯỢC ĐẶT'),
('P006', N'HOME STAY 06', N'PHÒNG VIP', '1600000', N'ĐẦY ĐỦ TIỆN NGHI', N'ĐÃ ĐƯỢC ĐẶT'),
('P007', N'HOME STAY 07', N'PHÒNG CHILL', '1250000', N'GƯỜNG LỚN, MÁY CHIẾU, BẾP NẤU', N'ĐÃ ĐƯỢC ĐẶT'),
('P008', N'HOME STAY 08', N'PHÒNG VIP', '1600000', N'ĐẦY ĐỦ TIỆN NGHI', N'ĐÃ ĐƯỢC ĐẶT'),


('P009', N'HOME STAY 09', N'PHÒNG CỔ ĐIỂN', '1300000',N'GƯỜNG LỚN, MÁY CHIẾU, BAN CÔNG NHỎ',  N'ĐÃ ĐƯỢC ĐẶT'),
('P010', N'HOME STAY 10',  N'PHÒNG CỔ ĐIỂN', '1300000', N'GƯỜNG LỚN, MÁY CHIẾU, BAN CÔNG NHỎ',  N'ĐÃ ĐƯỢC ĐẶT'),
('P011', N'HOME STAY 11',  N'PHÒNG CỔ ĐIỂN', '1300000', N'GƯỜNG LỚN, MÁY CHIẾU, BAN CÔNG NHỎ',  N'ĐÃ ĐƯỢC ĐẶT'),
('P012', N'HOME STAY 12', N'PHÒNG CHILL', '1250000', N'GƯỜNG LỚN, MÁY CHIẾU, BẾP NẤU', N'CÒN TRỐNG'),
('P013', N'HOME STAY 13',N'PHÒNG CHILL', '1250000', N'GƯỜNG LỚN, MÁY CHIẾU, BẾP NẤU', N'CÒN TRỐNG'),
('P014', N'HOME STAY 14', N'PHÒNG CHILL', '1250000', N'GƯỜNG LỚN, MÁY CHIẾU, BẾP NẤU', N'CÒN TRỐNG'),
('P015', N'HOME STAY 15', N'PHÒNG VIP', '1600000', N'ĐẦY ĐỦ TIỆN NGHI', N'CÒN TRỐNG'),
('P016', N'HOME STAY 16', N'PHÒNG VIP', '1600000', N'ĐẦY ĐỦ TIỆN NGHI', N'CÒN TRỐNG'),
('P017', N'HOME STAY 17', N'PHÒNG VIP', '1600000', N'ĐẦY ĐỦ TIỆN NGHI', N'CÒN TRỐNG')



SET DATEFORMAT DMY
INSERT INTO KHACHHANG(MAKH, TENKH, GIOITINH, NGAYSINH, DIACHI, SDT)
VALUES 
('KH001', N'THẾ BẢO', N'NAM','13-02-2002', N'PHẠM VĂN BẠCH', 0998768998),
('KH002', N'QUỐC PHÚ', N'NAM','01-05-2002', N'ÂU CƠ ', 0909876876),
('KH003', N'TUẤN ANH', N'NAM','05-12-2002', N'QUẬN 10', 0998734234),
('KH004', N'KHÁNH DUY', N'NAM','06-04-2002', N'BÌNH CHÁNH', 0998734456),

('KH005', N'NGỌC SƯƠNG', N'NỮ','04-10-2002', N'TIỀN GIANG',0772685679),
('KH006', N'KHÁNH NAM',' NNAM','06-04-1995', N'HÀ TĨNH',0885123456),
('KH007', N'TÙNG VĂN',  N'NAM','18-02-2003', N'LÂM ĐỒNG',0802954986),
('KH008', N'VĂN LONG',  N'NAM','15-08-2000', N'BÌNH CHÁNH',0125648741),
('KH009', N'QUỲNH NHƯ',N'NỮ','18-08-2000', N'TIỀN GIANG',0772512643),
('KH010', N'PHƯƠNG THẢO', N'NỮ','28-04-2002', N'TPHCM',01256412985),
('KH011', N'MINH QUÂN', N'NAM','27-12-2002', N'QUẢNG NAM',0365412573),
('KH012', N'NGỌC KHANG', N'NAM','16-10-2002', N'HÓC MÔN',0121495785),
('KH013', N'QUANG KIỆT', N'NAM','06-10-2002', N'BẠC LIÊU',0772528442),
('KH014', N'NHẬT HOÀNG', 'NAM','22-02-2002', N'TÂY NINH', 0156202304)


INSERT INTO NHANVIEN(MANV, TENNV, GIOITINH, NGAYSINH, DIACHI, SDT, TAIKHOAN, MATKHAU, QUYEN, AVATAR)
VALUES 
('NV001', N'NGUYỄN HOÀNG', 'NAM', '13-10-2002', N'MIỀN TÂY', 0211431698, N'hoang', N'123', N'QUẢN LÝ', 'avatar1.png'),
('NV002', N'NHẬT DUY','NAM', '01-03-2002', N'MIỀN TÂY', 0211431698, N'test',   N'123', N'NHÂN VIÊN', 'avatar2.png'),
('NV003', N'PHI BẰNG','NAM', '14-10-2002', N'MIỀN TÂY', 0211431698, N'bang',  N'123', N'NHÂN VIÊN', 'avatar3.png'),
('NV004', N'VĂN HOÀNG','NAM', '14-10-2002', N'MIỀN TÂY', 0211431698, N'duy',  N'123', N'QUẢN LÝ', 'avatar4.png')


SET DATEFORMAT DMY
INSERT INTO DATPHONG(MADP, MAPHONG, MAKH, NGAYDATPHONG, NGAYTRAPHONG, SONGUOI)
VALUES 
('DP001','P001', 'KH001', '15-04-2023', '17-04-2023', 1 ), 
('DP002','P002', 'KH002', '09-04-2023', '10-04-2023', 1 ), 
('DP003','P003', 'KH003', '03-04-2023', '05-04-2023', 1 ), 
('DP004','P004', 'KH004', '06-04-2023', '08-04-2023', 1 ),


('DP005','P005', 'KH005', '01-03-2023', '10-03-2023', 2 ),
('DP006','P006', 'KH006', '18-02-2023', '23-02-2023', 1 ),
('DP007','P007', 'KH007', '04-04-2023', '10-04-2023', 1 ),
('DP008','P008', 'KH008', '06-01-2023', '08-01-2023', 2 ),
('DP009','P009', 'KH009', '12-01-2023', '15-01-2023', 1 ),
('DP010','P010', 'KH010', '16-03-2023', '18-03-2023', 1 ),
('DP011','P011', 'KH011', '25-04-2023', '28-04-2023', 1 )



INSERT INTO LOAIDV(MALDV, TENLOAIDV)
VALUES
('LDV001', N'ĐỒ ĂN'),
('LDV002', N'ĐỒ UỐNG'),
('LDV003', N'TIỆN NGHI')


INSERT INTO DICHVU(MADV, TENDV, GIADV, MALDV)
VALUES 
('DV001', N'GIẶT ỦI', 20000,  'LDV003'),
('DV002', N'THUÊ XE MÁY', 100000, 'LDV003'),
('DV003', N'TRÁI CÂY DĨA LỚN',  40000, 'LDV001'),
('DV004', N'THỊT BÒ NƯỚNG', 80000, 'LDV001'),
('DV005', N'BIA TIGER BẠC', 315000, 'LDV002'),


('DV006', N'REDBULL', 15000, 'LDV002'),
('DV007', N'NƯỚC SUỐI AQUAFINA',9500, 'LDV002'),
('DV008', N'FUZE TEA',12000, 'LDV002'),
('DV009', N'THUÊ ĐỒ BƠI',30000, 'LDV003'),
('DV010', N'THUÊ MÁY ẢNH',60000, 'LDV003'),
('DV011', N'BIA 333', 18000, 'LDV002')




INSERT INTO PHUCVU(MAPV, MADV, MAPHONG, SL)
VALUES 
('PV001', 'DV001','P001', 2),
('PV002', 'DV002','P002', 3),
('PV003', 'DV003','P003', 4),
('PV004', 'DV004','P004', 5),
('PV005', 'DV005','P004', 5),
('PV006', 'DV001','P004', 5),


('PV007', 'DV006','P009', 3),
('PV008', 'DV011','P006', 1),
('PV009', 'DV010','P008', 8),
('PV010', 'DV003','P010', 5),
('PV011', 'DV005','P015', 5),
('PV012', 'DV003','P013', 4),
('PV013', 'DV008','P004', 1),
('PV014', 'DV009','P005', 2)




SET DATEFORMAT DMY
INSERT INTO HOADON(MADP, MAKH, MAPHONG, NGAYLAPHD, TONGTIENHD, MANV)
VALUES
('DP001', 'KH001', 'P001', '17-04-2023', 2480000, 'NV001'),
('DP002', 'KH002', 'P002', '10-04-2023', 2380000, 'NV001'),
('DP003', 'KH003', 'P003', '05-04-2023', 1420000, 'NV002'),
('DP004', 'KH004', 'P004', '08-04-2023', 1980000, 'NV002'),

('DP005', 'KH005', 'P005', '10-03-2023', 1310000, 'NV001'),
('DP006', 'KH006', 'P006', '23-02-2023', 1020000, 'NV001'),
('DP007', 'KH007', 'P007', '10-04-2023', 7200000, 'NV002'),
('DP008', 'KH008', 'P008', '08-01-2023', 6550000, 'NV002'),
('DP009', 'KH009', 'P009', '15-01-2023', 4740000, 'NV001'),
('DP010', 'KH010', 'P010', '18-03-2023', 3100000, 'NV001')



select MADV, TENDV, TENLOAIDV, GIADV from DichVu, LOAIDV where DICHVU.MALDV = LOAIDV.MALDV
select * from DICHVU



select * from HOADON


select * from PHONG

select * from KHACHHANG

select * from DATPHONG
select * from NHANVIEN

--lay du lieu tinh tien phong
select PHONG.MAPHONG, GIAPHONG, SONGUOI, DATEDIFF(DAY, NGAYDATPHONG, NGAYTRAPHONG) AS SONGAY from PHONG, DATPHONG where PHONG.MAPHONG = DATPHONG.MAPHONG AND PHONG.MAPHONG = 'P001'


--TÌM CÁC DỊCH VỤ LIEN QUAN TỚI PHÒNG 1, SAU KHI KHÁC ĐI THÌ XOÁ DỊCH VỤ LIÊN QUAN TỚI PHÒNG 1, XOÁ PHIEUDAT LIEN QUAN TỚI PHÒNG 1
select PHONG.MAPHONG, TENDV, GIADV, SL, SUM(SL) AS TONGSOLUONG from DATPHONG, DICHVU, PHUCVU, PHONG WHERE DICHVU.MADV = PHUCVU.MADV AND DATPHONG.MAPHONG = PHONG.MAPHONG AND PHONG.MAPHONG = 'P001'
GROUP BY  PHONG.MAPHONG, TENDV, GIADV, SL

INSERT INTO PHUCVU(MAPV, MADV, MAPHONG, SL)
VALUES
('PV0015', 'DV001','P004', 5) ---GỌI DỊCH VỤ GIẶT ỦI LẦN 2 SỐ LƯỢNG 5 TẠI PHÒNG P004

Select * from DICHVU

--xem dc so luong
SELECT PV.MAPHONG,DV.MADV, DV.TENDV, DV.GIADV, PV.SL,SUM(PV.SL) AS TONGSLDV
FROM DICHVU DV, PHUCVU PV 
WHERE PV.MADV = DV.MADV AND PV.MAPHONG = 'P004'
GROUP BY PV.MAPHONG,DV.MADV, DV.TENDV, DV.GIADV, PV.SL
--bỏ so luong 
SELECT PV.MAPHONG,DV.MADV, DV.TENDV, DV.GIADV,SUM(PV.SL) AS TONGSLDV
FROM DICHVU DV, PHUCVU PV 
WHERE PV.MADV = DV.MADV AND PV.MAPHONG = 'P004'
GROUP BY PV.MAPHONG,DV.MADV, DV.TENDV, DV.GIADV

select * from DATPHONG 
select * from HOADON
SELECT * FROM NHANVIEN WHERE MANV = ''
select * from PHUCVU


--them vào hoa don

SELECT HD.MAHD, NGAYLAPHD, KH.TENKH, PV.MAPHONG,DV.MADV, DV.TENDV, DV.GIADV,SUM(PV.SL) AS TONGSLDV
FROM DICHVU DV, PHUCVU PV, HOADON HD , KHACHHANG KH
WHERE PV.MADV = DV.MADV AND KH.MAKH = HD.MAKH AND PV.MAPHONG = 'P004'
GROUP BY HD.MAHD, NGAYLAPHD, KH.TENKH, PV.MAPHONG,DV.MADV, DV.TENDV, DV.GIADV

--CÁI NÀY SHOW RA DC THONG TIN 1 HOA DON NHUNG CHUA CO CHI TIET DICHV VU BEN TRONG
SELECT SONGUOI, DATEDIFF(DAY, NGAYDATPHONG, NGAYTRAPHONG) AS SONGAY, HOADON.MAPHONG MAHD, TENKH, TENNV, NGAYLAPHD, TONGTIENHD 
FROM HOADON, NHANVIEN, KHACHHANG, PHONG, DATPHONG
WHERE HOADON.MANV = NHANVIEN.MANV AND HOADON.MAKH = KHACHHANG.MAKH AND PHONG.MAPHONG = DATPHONG.MAPHONG AND DATPHONG.MAKH = HOADON.MAKH          AND HOADON.MAPHONG = 'P001'


--CÁI NÀY SHOW RA DC THONG TIN 1 HOA DON NHUNG CHUA CO CHI TIET DICHV VU BEN TRONG
SELECT DISTINCT GIAPHONG, (GIAPHONG*SONGUOI*DATEDIFF(DAY, NGAYDATPHONG, NGAYTRAPHONG)) AS TIENPHONG, TENDV, PHUCVU.SL, DICHVU.GIADV, (PHUCVU.SL * DICHVU.GIADV) 
AS THANHTIEN, SONGUOI, DATEDIFF(DAY, NGAYDATPHONG, NGAYTRAPHONG) AS SONGAY, HOADON.MAPHONG, MAHD, TENKH, TENNV, NGAYLAPHD, TONGTIENHD 
FROM HOADON, NHANVIEN, KHACHHANG, PHONG, DATPHONG, DICHVU, PHUCVU
WHERE HOADON.MANV = NHANVIEN.MANV AND HOADON.MAKH = KHACHHANG.MAKH AND PHONG.MAPHONG = DATPHONG.MAPHONG 
AND DATPHONG.MAKH = HOADON.MAKH AND PHUCVU.MAPHONG = HOADON.MAPHONG AND PHUCVU.MADV = DICHVU.MADV         AND HOADON.MAHD = 7


select * from DATPHONG 
select * from HOADON
select * from PHUCVU

select *from KHACHHANG
select *from NHANVIEN

select TENDV, PHUCVU.MADV from PHUCVU, DICHVU WHERE PHUCVU.MADV = DICHVU.MADV

select TENDV, COUNT(PHUCVU.MADV) AS SOLUONG from PHUCVU, DICHVU  WHERE PHUCVU.MADV = DICHVU.MADV
GROUP BY TENDV

--DOANH THU THÁNG
SELECT TONGTIENHD FROM HOADON WHERE Month(NGAYLAPHD) = '3' AND YEAR(NGAYLAPHD) = '2023' GROUP BY TONGTIENHD 

--DOANH THU NĂM
SELECT MAHD, NGAYLAPHD, COUNT(MONTH(NGAYLAPHD)) FROM HOADON WHERE YEAR(NGAYLAPHD) = '2023'
GROUP BY MAHD, NGAYLAPHD